/*
 postal
 Author: Jim Cowart (http://freshbrewedcode.com/jimcowart)
 License: Dual licensed MIT (http://www.opensource.org/licenses/mit-license) & GPL (http://www.opensource.org/licenses/gpl-license)
 Version 0.8.9
 */
(function(t,n){"object"==typeof module&&module.exports?module.exports=function(t){return t=t||require("underscore"),n(t)}:"function"==typeof define&&define.amd?define(["underscore"],function(i){return n(i,t)}):t.postal=n(t._,t)})(this,function(t,n){var i,e=function(t){var n=t.owner[t.prop];if("function"!=typeof n)throw Error("Strategies can only target methods.");var i=[],e=t.context||t.owner,r=function(){var t=0,r=function r(){var c,s=Array.prototype.slice.call(arguments,0),o=t;t+=1,i.length>o?(c=i[o],c.fn.apply(c.context||e,[r].concat(s))):n.apply(e,s)};r.apply(this,arguments)};return r.target=function(){return n},r.context=function(t){return 0===arguments.length?e:(e=t,undefined)},r.strategies=function(){return i},r.useStrategy=function(t){for(var n=0,e=!1;i.length>n;){if(i[n].name===t.name){i[n]=t,e=!0;break}n+=1}e||i.push(t)},r.reset=function(){i=[]},t.lazyInit?(n.useStrategy=function(){t.owner[t.prop]=r,r.useStrategy.apply(r,arguments)},n.context=function(){return t.owner[t.prop]=r,r.context.apply(r,arguments)},n):r},r={setTimeout:function(t){return{name:"setTimeout",fn:function(n,i,e){setTimeout(function(){n(i,e)},t)}}},after:function(n,i){var e=t.after(n,i);return{name:"after",fn:function(t,n,i){e(),t(n,i)}}},throttle:function(n){return{name:"throttle",fn:t.throttle(function(t,n,i){t(n,i)},n)}},debounce:function(n,i){return{name:"debounce",fn:t.debounce(function(t,n,i){t(n,i)},n,!!i)}},predicate:function(t){return{name:"predicate",fn:function(n,i,e){t.call(this,i,e)&&n.call(this,i,e)}}},distinct:function(t){t=t||{};var n=function(t){return t[0]},i=t.all?new s(n):new c(n);return{name:"distinct",fn:function(t,n,e){i(n)&&t(n,e)}}}},c=function(n){var i;return function(){var e=n(arguments),r=!1;return t.isString(e)?(r=e===i,i=e):(r=t.isEqual(e,i),i=t.clone(e)),!r}},s=function(n){var i=[];return function(){var e=n(arguments),r=!t.any(i,function(n){return t.isObject(e)||t.isArray(e)?t.isEqual(e,n):e===n});return r&&i.push(e),r}},o=function(t){this.channel=t||i.configuration.DEFAULT_CHANNEL};o.prototype.subscribe=function(){return 1===arguments.length?new a(this.channel,arguments[0].topic,arguments[0].callback):new a(this.channel,arguments[0],arguments[1])},o.prototype.publish=function(){var t=1===arguments.length?"[object String]"===Object.prototype.toString.call(arguments[0])?{topic:arguments[0]}:arguments[0]:{topic:arguments[0],data:arguments[1]};return t.channel=this.channel,i.configuration.bus.publish(t)};var a=function(t,n,e){this.channel=t,this.topic=n,this.subscribe(e),i.configuration.bus.publish({channel:i.configuration.SYSTEM_CHANNEL,topic:"subscription.created",data:{event:"subscription.created",channel:t,topic:n}}),i.configuration.bus.subscribe(this)};a.prototype={unsubscribe:function(){this.inactive||(this.inactive=!0,i.configuration.bus.unsubscribe(this),i.configuration.bus.publish({channel:i.configuration.SYSTEM_CHANNEL,topic:"subscription.removed",data:{event:"subscription.removed",channel:this.channel,topic:this.topic}}))},defer:function(){return this.callback.useStrategy(i.configuration.strategies.setTimeout(0)),this},disposeAfter:function(n){if(t.isNaN(n)||0>=n)throw"The value provided to disposeAfter (maxCalls) must be a number greater than zero.";var e=this;return e.callback.useStrategy(i.configuration.strategies.after(n,function(){e.unsubscribe.call(e)})),e},distinctUntilChanged:function(){return this.callback.useStrategy(i.configuration.strategies.distinct()),this},distinct:function(){return this.callback.useStrategy(i.configuration.strategies.distinct({all:!0})),this},once:function(){return this.disposeAfter(1),this},withConstraint:function(n){if(!t.isFunction(n))throw"Predicate constraint must be a function";return this.callback.useStrategy(i.configuration.strategies.predicate(n)),this},withContext:function(t){return this.callback.context(t),this},withDebounce:function(n,i){if(t.isNaN(n))throw"Milliseconds must be a number";var e=this.callback;return this.callback=t.debounce(e,n,!!i),this},withDelay:function(n){if(t.isNaN(n))throw"Milliseconds must be a number";return this.callback.useStrategy(i.configuration.strategies.setTimeout(n)),this},withThrottle:function(n){if(t.isNaN(n))throw"Milliseconds must be a number";return this.callback.useStrategy(i.configuration.strategies.throttle(n)),this},subscribe:function(t){return this.callback=t,this.callback=new e({owner:this,prop:"callback",context:this,lazyInit:!0}),this}};var u={cache:{},regex:{},compare:function(n,i){var e,r,c,s=this.cache[i]&&this.cache[i][n];return s!==undefined?s:((r=this.regex[n])||(e="^"+t.map(n.split("."),function(t){var n="";return c&&(n="#"!==c?"\\.\\b":"\\b"),n+="#"===t?"[\\s\\S]*":"*"===t?"[^.]+":t,c=t,n}).join("")+"$",r=this.regex[n]=RegExp(e)),this.cache[i]=this.cache[i]||{},this.cache[i][n]=s=r.test(i),s)},reset:function(){this.cache={},this.regex={}}},h=function(t,n){!t.inactive&&i.configuration.resolver.compare(t.topic,n.topic)&&t.callback.call(t.callback.context?t.callback.context():this,n.data,n)},f=0,l=[],p=function(){for(;l.length;)l.shift().unsubscribe()},b={addWireTap:function(t){var n=this;return n.wireTaps.push(t),function(){var i=n.wireTaps.indexOf(t);-1!==i&&n.wireTaps.splice(i,1)}},publish:function(n){return++f,n.timeStamp=new Date,t.each(this.wireTaps,function(t){t(n.data,n)}),this.subscriptions[n.channel]&&t.each(this.subscriptions[n.channel],function(t){for(var i,e=0,r=t.length;r>e;)(i=t[e++])&&h(i,n)}),0===--f&&p(),n},reset:function(){this.subscriptions&&(t.each(this.subscriptions,function(n){t.each(n,function(t){for(;t.length;)t.pop().unsubscribe()})}),this.subscriptions={})},subscribe:function(t){var n,i=this.subscriptions[t.channel];return i||(i=this.subscriptions[t.channel]={}),n=this.subscriptions[t.channel][t.topic],n||(n=this.subscriptions[t.channel][t.topic]=[]),n.push(t),t},subscriptions:{},wireTaps:[],unsubscribe:function(t){if(f)return l.push(t),undefined;if(this.subscriptions[t.channel][t.topic])for(var n=this.subscriptions[t.channel][t.topic].length,i=0;n>i;){if(this.subscriptions[t.channel][t.topic][i]===t){this.subscriptions[t.channel][t.topic].splice(i,1);break}i+=1}}};if(i={configuration:{bus:b,resolver:u,DEFAULT_CHANNEL:"/",SYSTEM_CHANNEL:"postal",strategies:r},ChannelDefinition:o,SubscriptionDefinition:a,channel:function(t){return new o(t)},subscribe:function(t){return new a(t.channel||i.configuration.DEFAULT_CHANNEL,t.topic,t.callback)},publish:function(t){return t.channel=t.channel||i.configuration.DEFAULT_CHANNEL,i.configuration.bus.publish(t)},addWireTap:function(t){return this.configuration.bus.addWireTap(t)},linkChannels:function(n,e){var r=[];return n=t.isArray(n)?n:[n],e=t.isArray(e)?e:[e],t.each(n,function(n){var c=n.topic||"#";t.each(e,function(e){var s=e.channel||i.configuration.DEFAULT_CHANNEL;r.push(i.subscribe({channel:n.channel||i.configuration.DEFAULT_CHANNEL,topic:c,callback:function(n,r){var c=t.clone(r);c.topic=t.isFunction(e.topic)?e.topic(r.topic):e.topic||r.topic,c.channel=s,c.data=n,i.publish(c)}}))})}),r},utils:{getSubscribersFor:function(){var t=arguments[0],n=arguments[1];return 1===arguments.length&&(t=arguments[0].channel||i.configuration.DEFAULT_CHANNEL,n=arguments[0].topic),i.configuration.bus.subscriptions[t]&&Object.prototype.hasOwnProperty.call(i.configuration.bus.subscriptions[t],n)?i.configuration.bus.subscriptions[t][n]:[]},reset:function(){i.configuration.bus.reset(),i.configuration.resolver.reset()}}},b.subscriptions[i.configuration.SYSTEM_CHANNEL]={},n&&n.hasOwnProperty("__postalReady__")&&t.isArray(n.__postalReady__))for(;n.__postalReady__.length;)n.__postalReady__.shift().onReady(i);return i});